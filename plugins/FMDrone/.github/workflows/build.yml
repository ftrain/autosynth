name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: Linux
          - os: macos-14
            name: macOS
          - os: windows-latest
            name: Windows

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      # ======================================================================
      # Checkout
      # ======================================================================
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # ======================================================================
      # Linux Dependencies
      # ======================================================================
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libx11-dev \
            libxinerama-dev \
            libxext-dev \
            libfreetype6-dev \
            libwebkit2gtk-4.0-dev \
            libglu1-mesa-dev \
            libcurl4-openssl-dev \
            libjack-jackd2-dev

      # ======================================================================
      # Node.js for UI build
      # ======================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      # ======================================================================
      # Build UI
      # ======================================================================
      - name: Build UI
        run: |
          cd ui
          npm ci
          npm run build

      # ======================================================================
      # CMake Configure
      # ======================================================================
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      # ======================================================================
      # Build
      # ======================================================================
      - name: Build
        run: cmake --build build --config Release --parallel

      # ======================================================================
      # Test
      # ======================================================================
      - name: Test
        run: ctest --test-dir build -C Release --output-on-failure

      # ======================================================================
      # Upload Artifacts
      # ======================================================================
      - name: Upload VST3 (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-VST3
          path: build/*_artefacts/Release/VST3/*.vst3
          retention-days: 7

      - name: Upload VST3 (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-VST3
          path: build/*_artefacts/Release/VST3/*.vst3
          retention-days: 7

      - name: Upload AU (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-AU
          path: build/*_artefacts/Release/AU/*.component
          retention-days: 7

      - name: Upload VST3 (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-VST3
          path: build/*_artefacts/Release/VST3/*.vst3
          retention-days: 7

  # ==========================================================================
  # Plugin Validation (optional)
  # ==========================================================================
  validate:
    needs: build
    runs-on: ubuntu-22.04
    name: Validate Plugin

    steps:
      - name: Download Linux VST3
        uses: actions/download-artifact@v4
        with:
          name: Linux-VST3
          path: plugins

      - name: Install pluginval
        run: |
          wget -q https://github.com/Tracktion/pluginval/releases/download/v1.0.3/pluginval_Linux.zip
          unzip pluginval_Linux.zip

      - name: Run pluginval
        run: |
          # Find VST3 files
          VST3=$(find plugins -name "*.vst3" | head -1)
          if [ -n "$VST3" ]; then
            ./pluginval --validate-in-process --strictness-level 5 "$VST3" || true
          fi
