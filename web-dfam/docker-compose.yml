services:
  # Build DFAM WASM
  wasm-builder:
    image: emscripten/emsdk:3.1.51
    volumes:
      - ./src/dsp:/app/src/dsp:ro
      - ./public:/app/public
    working_dir: /app
    command: ["bash", "-c", "emcc -std=c++17 -O3 -s WASM=1 -s MODULARIZE=1 -s EXPORT_NAME='createDFAMModule' -s EXPORTED_FUNCTIONS='[\"_init\",\"_process\",\"_setRunning\",\"_isRunning\",\"_setTempo\",\"_setClockDivider\",\"_setStepPitch\",\"_setStepVelocity\",\"_getCurrentStep\",\"_setVCO1Frequency\",\"_setVCO2Frequency\",\"_setVCO1Level\",\"_setVCO2Level\",\"_setVCO1Waveform\",\"_setVCO2Waveform\",\"_setFMAmount\",\"_setNoiseLevel\",\"_setFilterCutoff\",\"_setFilterResonance\",\"_setFilterEnvAmount\",\"_setFilterMode\",\"_setFilterLfoRate\",\"_setFilterLfoClockSync\",\"_setFilterLfoAmount\",\"_setPitchEnvAttack\",\"_setPitchEnvDecay\",\"_setPitchEnvAmount\",\"_setVCFVCAEnvAttack\",\"_setVCFVCAEnvDecay\",\"_setSaturatorDrive\",\"_setSaturatorMix\",\"_setDelayTime\",\"_setDelayClockSync\",\"_setDelayFeedback\",\"_setDelayMix\",\"_setReverbDecay\",\"_setReverbDamping\",\"_setReverbMix\",\"_setMasterVolume\",\"_malloc\",\"_free\"]' -s EXPORTED_RUNTIME_METHODS='[\"ccall\",\"cwrap\"]' -s ALLOW_MEMORY_GROWTH=1 -s INITIAL_MEMORY=33554432 -s ENVIRONMENT='web,worker' -I src/dsp src/dsp/wasm_bindings.cpp -o public/dfam.js && echo 'DFAM WASM build complete!'"]

  # Build TapeLoop WASM
  tapeloop-builder:
    image: emscripten/emsdk:3.1.51
    volumes:
      - ./src/dsp:/app/src/dsp:ro
      - ./public:/app/public
    working_dir: /app
    command: ["bash", "-c", "emcc -std=c++17 -O3 -s WASM=1 -s MODULARIZE=1 -s EXPORT_NAME='createTapeLoopModule' -s EXPORTED_FUNCTIONS='[\"_init\",\"_process\",\"_noteOn\",\"_noteOff\",\"_clearTape\",\"_setOsc1Waveform\",\"_setOsc1Tune\",\"_setOsc1Level\",\"_setOsc2Waveform\",\"_setOsc2Tune\",\"_setOsc2Detune\",\"_setOsc2Level\",\"_setFMAmount\",\"_setLoopLength\",\"_setLoopFeedback\",\"_setRecordLevel\",\"_setSaturation\",\"_setWobbleRate\",\"_setWobbleDepth\",\"_setTapeHiss\",\"_setTapeAge\",\"_setTapeDegrade\",\"_setLFORate\",\"_setLFODepth\",\"_setLFOWaveform\",\"_setLFOTarget\",\"_setDryLevel\",\"_setLoopLevel\",\"_setMasterLevel\",\"_setRecAttack\",\"_setRecDecay\",\"_setDelayTime\",\"_setDelayFeedback\",\"_setDelayMix\",\"_setReverbDecay\",\"_setReverbDamping\",\"_setReverbMix\",\"_setSeqEnabled\",\"_setSeqBPM\",\"_setSeq1Division\",\"_setSeq1StepPitch\",\"_setSeq1StepGate\",\"_setSeq2Division\",\"_setSeq2StepPitch\",\"_setSeq2StepGate\",\"_setVoiceLoopFM\",\"_setPanSpeed\",\"_setPanDepth\",\"_getSeq1CurrentStep\",\"_getSeq2CurrentStep\",\"_malloc\",\"_free\"]' -s EXPORTED_RUNTIME_METHODS='[\"ccall\",\"cwrap\"]' -s ALLOW_MEMORY_GROWTH=1 -s INITIAL_MEMORY=67108864 -s ENVIRONMENT='web,worker' -I src/dsp/tapeloop src/dsp/tapeloop/wasm_bindings.cpp -o public/tapeloop.js && echo 'TapeLoop WASM build complete!'"]

  # Build all WASM modules
  wasm-all:
    image: emscripten/emsdk:3.1.51
    volumes:
      - ./src/dsp:/app/src/dsp:ro
      - ./public:/app/public
    working_dir: /app
    command: ["bash", "-c", "emcc -std=c++17 -O3 -s WASM=1 -s MODULARIZE=1 -s EXPORT_NAME='createDFAMModule' -s EXPORTED_FUNCTIONS='[\"_init\",\"_process\",\"_setRunning\",\"_isRunning\",\"_setTempo\",\"_setClockDivider\",\"_setStepPitch\",\"_setStepVelocity\",\"_getCurrentStep\",\"_setVCO1Frequency\",\"_setVCO2Frequency\",\"_setVCO1Level\",\"_setVCO2Level\",\"_setVCO1Waveform\",\"_setVCO2Waveform\",\"_setFMAmount\",\"_setNoiseLevel\",\"_setFilterCutoff\",\"_setFilterResonance\",\"_setFilterEnvAmount\",\"_setFilterMode\",\"_setFilterLfoRate\",\"_setFilterLfoClockSync\",\"_setFilterLfoAmount\",\"_setPitchEnvAttack\",\"_setPitchEnvDecay\",\"_setPitchEnvAmount\",\"_setVCFVCAEnvAttack\",\"_setVCFVCAEnvDecay\",\"_setSaturatorDrive\",\"_setSaturatorMix\",\"_setDelayTime\",\"_setDelayClockSync\",\"_setDelayFeedback\",\"_setDelayMix\",\"_setReverbDecay\",\"_setReverbDamping\",\"_setReverbMix\",\"_setMasterVolume\",\"_malloc\",\"_free\"]' -s EXPORTED_RUNTIME_METHODS='[\"ccall\",\"cwrap\"]' -s ALLOW_MEMORY_GROWTH=1 -s INITIAL_MEMORY=33554432 -s ENVIRONMENT='web,worker' -I src/dsp src/dsp/wasm_bindings.cpp -o public/dfam.js && echo 'DFAM WASM build complete!' && emcc -std=c++17 -O3 -s WASM=1 -s MODULARIZE=1 -s EXPORT_NAME='createTapeLoopModule' -s EXPORTED_FUNCTIONS='[\"_init\",\"_process\",\"_noteOn\",\"_noteOff\",\"_clearTape\",\"_setOsc1Waveform\",\"_setOsc1Tune\",\"_setOsc1Level\",\"_setOsc2Waveform\",\"_setOsc2Tune\",\"_setOsc2Detune\",\"_setOsc2Level\",\"_setFMAmount\",\"_setLoopLength\",\"_setLoopFeedback\",\"_setRecordLevel\",\"_setSaturation\",\"_setWobbleRate\",\"_setWobbleDepth\",\"_setTapeHiss\",\"_setTapeAge\",\"_setTapeDegrade\",\"_setLFORate\",\"_setLFODepth\",\"_setLFOWaveform\",\"_setLFOTarget\",\"_setDryLevel\",\"_setLoopLevel\",\"_setMasterLevel\",\"_setRecAttack\",\"_setRecDecay\",\"_setDelayTime\",\"_setDelayFeedback\",\"_setDelayMix\",\"_setReverbDecay\",\"_setReverbDamping\",\"_setReverbMix\",\"_setSeqEnabled\",\"_setSeqBPM\",\"_setSeq1Division\",\"_setSeq1StepPitch\",\"_setSeq1StepGate\",\"_setSeq2Division\",\"_setSeq2StepPitch\",\"_setSeq2StepGate\",\"_setVoiceLoopFM\",\"_setPanSpeed\",\"_setPanDepth\",\"_getSeq1CurrentStep\",\"_getSeq2CurrentStep\",\"_malloc\",\"_free\"]' -s EXPORTED_RUNTIME_METHODS='[\"ccall\",\"cwrap\"]' -s ALLOW_MEMORY_GROWTH=1 -s INITIAL_MEMORY=67108864 -s ENVIRONMENT='web,worker' -I src/dsp/tapeloop src/dsp/tapeloop/wasm_bindings.cpp -o public/tapeloop.js && echo 'TapeLoop WASM build complete!'"]

  # Production: Full build and serve
  dfam-web:
    build: .
    ports:
      - "8080:8080"
